<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Geospatial with R – EC242</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-8f59e15428d7e58554b9544b4f1fd2fe.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": "tree",
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../images/Spartan-Helmet_White.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">EC242</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../syllabus.html"> 
<span class="menu-text">Syllabus</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../schedule.html"> 
<span class="menu-text">Schedule</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../../content/index.html" aria-current="page"> 
<span class="menu-text">Course Content</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../assignment/index.html"> 
<span class="menu-text">Assignments</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../resource/index.html"> 
<span class="menu-text">Resources</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://ec242.slack.com"> <i class="bi bi-slack" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../content/index.html">Course Content</a></li><li class="breadcrumb-item"><a href="../../content/Week_15/15a.html">Week 15</a></li><li class="breadcrumb-item"><a href="../../content/Week_15/15a.html">Geospatial with R</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
  <div id="quarto-announcement" data-announcement-id="7b85ba478406ce3f88dc626c1c237817" class="alert alert-primary hidden"><i class="bi bi-info-circle quarto-announcement-icon"></i><div class="quarto-announcement-content">
<p>Welcome to Spring Semester 2025.</p>
</div><i class="bi bi-x-lg quarto-announcement-action"></i></div>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../content/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Course Content</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false">
 <span class="menu-text">Week 01</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_01/01a.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome To Data Analytics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_01/01b.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Working with R and RStudio</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false">
 <span class="menu-text">Week 02</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_02/02a.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to the tidyverse</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_02/02b.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to Visualization</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false">
 <span class="menu-text">Week 03</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_03/03a.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Effective Visualizations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_03/03b.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ggplot2: Everything you ever wanted to know</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false">
 <span class="menu-text">Week 04</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_04/04a.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Visualizations in Practice</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_04/04b.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Visualizations</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false">
 <span class="menu-text">Week 05</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_05/05a.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Probability and Statistics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_05/05b.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Visualizing Uncertainty</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="false">
 <span class="menu-text">Week 06</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_06/06a.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Foundations of Linear Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_06/06b.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to Regression</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="false">
 <span class="menu-text">Week 07</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_07/07a.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Linear Regression II</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_07/07b.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Linear Regression: Interpreting Coefficients</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="false">
 <span class="menu-text">Week 08</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_08/08a.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Linear Regression III</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_08/08b.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Model Selection in Linear Regression</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" role="navigation" aria-expanded="false">
 <span class="menu-text">Week 09</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-10" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_09/09b.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Shrinkage with LASSO and Ridge</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" role="navigation" aria-expanded="false">
 <span class="menu-text">Week 10</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-11" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_10/10a.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Nonparametric Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_10/10b.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Nonparametric Regression</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-12" role="navigation" aria-expanded="false">
 <span class="menu-text">Week 11</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-12" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-12" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_11/11a.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">TBA</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_11/11b.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bias-Variance Tradeoff and Random Forests</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-13" role="navigation" aria-expanded="false">
 <span class="menu-text">Week 12</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-13" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-13" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_12/12a.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Classification</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_12/12b.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Illustrating Classification</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-14" role="navigation" aria-expanded="false">
 <span class="menu-text">Week 13</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-14" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-14" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_13/13a.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Wrangling</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_13/13b.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Wrangle some Data</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-15" role="navigation" aria-expanded="false">
 <span class="menu-text">Week 14</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-15" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-15" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_14/14a.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Text as Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_14/14b.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Thanksgiving Holiday</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-16" role="navigation" aria-expanded="true">
 <span class="menu-text">Week 15</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-16" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-16" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_15/15a.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Geospatial with R</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/Week_15/15b.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Geospatial with R</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2">
    <h2 id="toc-title">On this page</h2>
   
  <ul class="collapse">
  <li><a href="#required-reading" id="toc-required-reading" class="nav-link active" data-scroll-target="#required-reading">Required Reading</a></li>
  <li><a href="#geospatial-in-r" id="toc-geospatial-in-r" class="nav-link" data-scroll-target="#geospatial-in-r">Geospatial in R</a>
  <ul class="collapse">
  <li><a href="#vector-vs.-raster" id="toc-vector-vs.-raster" class="nav-link" data-scroll-target="#vector-vs.-raster">Vector vs.&nbsp;Raster</a></li>
  </ul></li>
  <li><a href="#vectors-points-lines-and-polygons" id="toc-vectors-points-lines-and-polygons" class="nav-link" data-scroll-target="#vectors-points-lines-and-polygons">Vectors: points, lines, and polygons</a></li>
  <li><a href="#reading-spatial-data" id="toc-reading-spatial-data" class="nav-link" data-scroll-target="#reading-spatial-data">Reading spatial data</a>
  <ul class="collapse">
  <li><a href="#spatial-merges" id="toc-spatial-merges" class="nav-link" data-scroll-target="#spatial-merges">Spatial merges</a></li>
  <li><a href="#cropping-vs.-merging" id="toc-cropping-vs.-merging" class="nav-link" data-scroll-target="#cropping-vs.-merging">Cropping vs.&nbsp;merging</a></li>
  <li><a href="#distance-matrices" id="toc-distance-matrices" class="nav-link" data-scroll-target="#distance-matrices">Distance matrices</a></li>
  <li><a href="#other-resources" id="toc-other-resources" class="nav-link" data-scroll-target="#other-resources">Other resources</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../content/index.html">Course Content</a></li><li class="breadcrumb-item"><a href="../../content/Week_15/15a.html">Week 15</a></li><li class="breadcrumb-item"><a href="../../content/Week_15/15a.html">Geospatial with R</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Geospatial with R</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="required-reading" class="level2">
<h2 class="anchored" data-anchor-id="required-reading">Required Reading</h2>
<ul>
<li>This page.</li>
</ul>
<section id="guiding-questions" class="level3">
<h3 class="anchored" data-anchor-id="guiding-questions">Guiding Questions</h3>
<ul>
<li>What are the building blocks of geospatial data?</li>
<li>How do we handle uniquely geospatial properties like distance or spatial correlation?</li>
</ul>
</section>
</section>
<section id="geospatial-in-r" class="level1">
<h1>Geospatial in R</h1>
<p>We will need a handful of new packages for our introduction to geospatial analysis in R. The primary package we will interact with is the <code>sf</code> package. <code>sf</code> stands for “simple features.” It has become the standard for geospatial work in R, and relies on the <code>rgeos</code> and <code>rgdal</code> libraries (which are themselves <code>R</code> compilations of the <code>geos</code> and <code>gdal</code> libraries). Documentation of sf <a href="https://r-spatial.github.io/sf/">can be found here</a>.</p>
<p>We will also use the <code>mapview</code> package, as well as the <code>tmaptools</code> package. Plus, we’ll use <code>tigris</code> to get state boundaries and <code>tidycensus</code> to pull down census maps. Install those, and any of the many dependencies that they also install.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mapview)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tigris)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidycensus)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmaptools)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="vector-vs.-raster" class="level2">
<h2 class="anchored" data-anchor-id="vector-vs.-raster">Vector vs.&nbsp;Raster</h2>
<p>There are two ways of storing 2-D mapped spatial data, <em>raster</em> and <em>vector</em>. A <em>vector</em> representation of a 2-D shape is best described as an irregular polygon with points defining vertices. A square plotted in cartesian coordinates is a vector representation. Conversely, a <em>raster</em> image is a grid of cells where each cell is defined as “in” or “out” of the square. Most computer graphics like JPEG and TIFF are raster graphics and each pixel has an assigned color. To make a raster image of a blue square, we’d make a big grid of pixels, and then color some blue based on their location. To make a blue square in vector form, we’d record <em>just the location of the corners</em> and add instructions to color inside the polygon formed by those corners blue.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://vector-conversions.com/images/vector_vs_raster.jpg" class="img-fluid figure-img" style="width:50.0%"></p>
</figure>
</div>
</div>
</div>
<section id="vectors-are-scalable.-rasters-are-not" class="level3">
<h3 class="anchored" data-anchor-id="vectors-are-scalable.-rasters-are-not">Vectors are scalable. Rasters are not</h3>
<p>Rasters are great for detail, like pixels in a picture, but they do not scale up very well. Vectors are great for things that do need to scale up. They are also smaller and easier to work with when they aren’t trying to replicate photo-realistic images. Vectors can handle curves by recording the properties of the curve (e.g.&nbsp;bezier curves), while rasters have to approximate curves along the grid of cells, so if you want a smooth curve, you need lots of cells.</p>
<p>Geospatial work is almost always done in vectors because (1) it is easier to store data as vectors, and (2) it is easier to manipulate, project, intersect, or connect vector points, lines, and polygons.</p>
<p>We are going to work entirely with vectors today.</p>
</section>
</section>
</section>
<section id="vectors-points-lines-and-polygons" class="level1">
<h1>Vectors: points, lines, and polygons</h1>
<p>Most everything we would want to map can be represented as a point, a line, or a polygon. Points could be the location of power plants in the US, or the location of COVID cases, or the location of major intersections. Lines could be the location of train tracks, the shortest distance between someone’s house and the nearest restaurants, or a major road. Polygons could be county boundaries, landowner’s lot lines, or bodies of water.</p>
<p>We can start by making some points, then turning them into a polygon. We’ll just use arbitrary coordinates for now, but will move into GPS latitude-longitude coordinates shortly. We’ll use <code>st_multipoint</code> to create our points object. It takes a numeric matrix only.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>myPoints <span class="ot">=</span> <span class="fu">tribble</span>(<span class="sc">~</span>X, <span class="sc">~</span>Y,</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                   <span class="dv">0</span>, <span class="dv">0</span>,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                   <span class="dv">0</span>, <span class="dv">4</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                   <span class="dv">1</span>, <span class="dv">4</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>                   <span class="dv">1</span>, <span class="dv">1</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>                   .<span class="dv">5</span>, <span class="dv">0</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>                   <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>myPoints <span class="ot">=</span> <span class="fu">st_multipoint</span>(<span class="fu">as.matrix</span>(myPoints))</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(myPoints)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15a_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="making-polygons" class="level3">
<h3 class="anchored" data-anchor-id="making-polygons">Making polygons</h3>
<p>We’ve begun making our first spatial object! Now, we can turn it into a polygon under one condition: the polygon has to “close” in order for R to know which side is the inside. In <code>myPoints</code>, the <em>last</em> point is identical to the <em>first</em> point, so R will “close” it:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_polygon</span>(<span class="fu">list</span>(myPoints)), <span class="at">col =</span> <span class="st">'darkgreen'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15a_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>That’s just one polylgon. Let’s add another one. When we created the polygon, we put the points object, <code>myPoints</code>, into a list. If we have a list of, say, two points objects, then we’ll get two polygons:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>myPoints2 <span class="ot">=</span> <span class="fu">tribble</span>(<span class="sc">~</span>X, <span class="sc">~</span>Y,</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>                    <span class="dv">1</span>,<span class="dv">1</span>,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                    <span class="dv">2</span>,<span class="dv">1</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                    <span class="dv">2</span>,<span class="dv">2</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                    <span class="dv">1</span>,<span class="dv">2</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                    <span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>myPoints2 <span class="ot">=</span> <span class="fu">st_multipoint</span>(<span class="fu">as.matrix</span>(myPoints2))</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>myPolygons <span class="ot">=</span> <span class="fu">st_polygon</span>(<span class="fu">list</span>(myPoints, myPoints2))</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(myPolygons, <span class="at">col =</span> <span class="st">'lightblue'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15a_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now we can see two polygons. Looking at the <code>str</code>ucture of the polygons:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(myPolygons)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 2
 $ : 'XY' num [1:6, 1:2] 0 0 1 1 0.5 0 0 4 4 1 ...
  ..- attr(*, "dimnames")=List of 2
  .. ..$ : NULL
  .. ..$ : chr [1:2] "X" "Y"
 $ : 'XY' num [1:5, 1:2] 1 2 2 1 1 1 1 2 2 1
  ..- attr(*, "dimnames")=List of 2
  .. ..$ : NULL
  .. ..$ : chr [1:2] "X" "Y"
 - attr(*, "class")= chr [1:3] "XY" "POLYGON" "sfg"</code></pre>
</div>
</div>
<p>Notice that one of the classes is <code>sfg</code>. This is a <code>sf</code> package-defined spatial object.</p>
</section>
<section id="getting-points-on-a-plot" class="level3">
<h3 class="anchored" data-anchor-id="getting-points-on-a-plot">Getting points on a plot</h3>
<p>One little-known trick in R is super helpful in spatial work. If you <code>plot(myPolygons)</code> in your own R-studio console (so it appears in your “Plots” pane, not knit into your document), you can use <code>click(n)</code> to interactively get <span class="math inline">\(n\)</span> spatial points in the coordinate system of your plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>myClicks <span class="ot">=</span> <span class="fu">click</span>(<span class="at">n =</span> <span class="dv">3</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>myClicks <span class="ot">=</span> <span class="fu">rbind</span>(myClicks, myClicks[<span class="dv">1</span>,])  <span class="co"># copy the first point to the last point to "close"</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>myNewPolygon <span class="ot">=</span> <span class="fu">st_polygon</span>(<span class="fu">list</span>(<span class="fu">st_multipoint</span>(myClicks)))</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(myPolygons, <span class="at">col =</span> <span class="st">'lightblue'</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(myNewPolygon, <span class="at">col =</span> <span class="st">'green'</span>, <span class="at">add=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15a_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="making-lines" class="level3">
<h3 class="anchored" data-anchor-id="making-lines">Making lines</h3>
<p>We could also create a line with our points. I’ll leave off the one point we added to “close” the polygon. Note that the line is colored blue, not the (uncompleted) polygon.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>myLine <span class="ot">=</span> <span class="fu">st_linestring</span>(myPoints[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,])</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(myLine, <span class="at">col =</span> <span class="st">'blue'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15a_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="reading-spatial-data" class="level1">
<h1>Reading spatial data</h1>
<p>While it’s fun to draw our own shapes (caution: my definition of fun <span class="math inline">\(\neq\)</span> your definition of fun), we’re probably most interested in finding and using existing spatial data. Let’s talk briefly about the types of spatial data out there:</p>
<ul>
<li>Shapefiles
<ul>
<li>Shapefiles are not actually single files - they’re usually 4-6 files with similar names and different suffixes like .dbf, .shx, etc. This is because the shapefile format kind of pre-dates our current way of thinking of file storage. The most common program for reading or making shapefiles is ESRI’s ArcGIS. It is expensive, cumbersome, and some may say bloated. Our goal in this section is to be able to rescue shapefiles from the clutches of ArcGIS and open them in R</li>
</ul></li>
<li>GEOJSON
<ul>
<li>JSON is a way of structuring text data (like a .csv) but with the potential for nests in the data (like our <code>list</code> object) where each nest has a different data structure. GEOJSON pairs this with <strong>WKT</strong> or Well-Known Text representations of coordinates and takes care of making sure that each observation in the JSON data has a corresponding polygon in WKT coordinates.</li>
</ul></li>
<li>KML
<ul>
<li>Bare-bones storage of coordinates and basic data</li>
</ul></li>
<li>.RDS
<ul>
<li>Okay, this is just R’s native data type for storage, but it’s really helpful for storing <code>sf</code> objects</li>
</ul></li>
<li>Comma separated values (.csv)
<ul>
<li>Just like the CSV’s we’ve been using, but with Latitude and Longitude columns. Only works for points (one point per .csv line), but is very commonly found. We can use <code>st_as_sf</code> to tell R which columns are the latitude and longitude.</li>
</ul></li>
</ul>
<p>We can open and use any one of these filetypes. I will cover Shapefiles and GEOJSON as the latter has become a very popular way of sharing spatial datasets.</p>
<section id="where-to-find-spatial-data" class="level3">
<h3 class="anchored" data-anchor-id="where-to-find-spatial-data">Where to find spatial data</h3>
<p>Spatial data is all around us! Try searching google for a topic + “spatial shapefile”. One of my favorite sources for spatial data is the DHS <a href="https://hifld-geoplatform.hub.arcgis.com">HIFLD Open database</a>, which has lots of government datasets that are well-organized by category. Click through, choose the “open” database, and when you find something you like, click the “Download” button. If there is a GEOJSON or KML file available, <strong>right-click</strong> and copy the link address, or click on <strong>full details</strong> and scroll down to <em>I want to…View API Resources</em> and copy the GEOJSON link. Then, use that with <code>st_read()</code>. On many maps (including this one), the GeoJSON link is shown under the API drop-down. Use GeoJSON over KML as some systems have issues importing the data fields in KML.</p>
</section>
<section id="loading-the-data" class="level3">
<h3 class="anchored" data-anchor-id="loading-the-data">Loading the data</h3>
<p>We’ll use the <code>sf</code> package’s <code>st_read</code> to open spatial data. Here, I’m loading the Natural Gas Processing Plants data from the Energy section of HIFLD. I’m using the <strong>GeoJSON</strong> option, which <code>st_read()</code> knows how to handle:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>gasplants <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">'https://services7.arcgis.com/FGr1D95XCGALKXqM/arcgis/rest/services/NaturalGas_ProcessingPlants_US_EIA/FeatureServer/23/query?outFields=*&amp;where=1%3D1&amp;f=geojson'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="at">name =</span> Plant_Name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `OGRGeoJSON' from data source 
  `https://services7.arcgis.com/FGr1D95XCGALKXqM/arcgis/rest/services/NaturalGas_ProcessingPlants_US_EIA/FeatureServer/23/query?outFields=*&amp;where=1%3D1&amp;f=geojson' 
  using driver `GeoJSON'
Simple feature collection with 478 features and 18 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -120.4329 ymin: 26.42119 xmax: -78.6591 ymax: 48.87366
Geodetic CRS:  WGS 84</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gasplants)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 1 field
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -111.9598 ymin: 31.29948 xmax: -95.51805 ymax: 48.73838
Geodetic CRS:  WGS 84
                           name                   geometry
1 50 Buttes Processing Facility POINT (-105.7778 43.85235)
2                    Ajax Plant  POINT (-100.1163 35.5464)
3                         Alamo POINT (-95.51805 31.29948)
4             Allison Gas Plant POINT (-100.1451 35.61864)
5                 Aloe Ventures POINT (-111.9598 48.73838)
6            Altamont Gas Plant  POINT (-110.329 40.35807)</code></pre>
</div>
</div>
<p>The <code>sf</code> data type holds both the data (which here is just the name of the plant) <em>and</em> the “geometry”, which are the points. It’s tidy data - one row is one observation of one plant, and each row has a set of coordinates telling us where to find the plant.</p>
<p>We can use ggplot with <code>geom_sf()</code> to plot these points. They’re just scattered across the country and we don’t automatically get a background map, but here are the points</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(gasplants) <span class="sc">+</span> <span class="fu">geom_sf</span>() <span class="sc">+</span> <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15a_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Well, we’re missing some context here – we can kind of make out the point of Texas down there, but it’s hard to tell anything about where these plants are located. Let’s use <code>tigris</code> to get a map of the US, then plot it plus the points. Note we use different <code>data =</code> in each of the <code>geom_sf()</code> calls:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>US <span class="ot">&lt;-</span> tigris<span class="sc">::</span><span class="fu">states</span>(<span class="at">cb =</span> <span class="cn">TRUE</span>, <span class="at">progress_bar =</span> <span class="cn">FALSE</span>)  <span class="co"># tigris maps</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_sf</span>(<span class="at">data =</span> US, <span class="at">col =</span> <span class="st">'gray50'</span>) <span class="sc">+</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> gasplants) <span class="sc">+</span> <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15a_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Getting there. The problem now is that the <code>tigris</code> data covers all US territories, which are really spread out! Let’s drop down to just Michigan. We can use good old <code>filter</code> just like with regular data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>MI <span class="ot">=</span> tigris<span class="sc">::</span><span class="fu">states</span>(<span class="at">cb =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(STUSPS<span class="sc">==</span><span class="st">'MI'</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_sf</span>(<span class="at">data =</span> MI, <span class="at">col =</span> <span class="st">'gray50'</span>) <span class="sc">+</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> gasplants) <span class="sc">+</span> <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15a_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Well, now we have a different problem. We want to have only the <code>gasplants</code> that are <code>over</code> the state of Michigan. That requires a <strong>spatial join</strong>. Luckily, our <code>tidyverse</code> syntax <strong>works pretty seamlessly on <code>sf</code> objects</strong>. First, we have to take care of a little issue with spatial data. The <strong>projection</strong></p>
</section>
<section id="projections-briefly" class="level3">
<h3 class="anchored" data-anchor-id="projections-briefly">Projections, briefly</h3>
<p>The <em>projection</em> for spatial data is the translation from a 3-D object (e.g.&nbsp;the globe) to a 2-D space (a map, or the cartesian x-y coordinates of our screen). This is no simple matter! There are entire PhD programs dedicated to forming and processing projections and datum (which refer to the shape of the globe, which is not actually round). It can all be a nightmare. Worst of all, projections determine the definition of your coordinates, so you may be at -81 latitude, +30 longitude, but in another projection, you might be 1245349m above some reference point, and -2452849m to the left of that point. Projections define the distance along the X and Y axis, the scale of the coordinates, and a lot of other stuff about your 2-D polygons.</p>
<p>Luckily, over the last few years, very smart people have been working on regularizing “projections”. Now, we really need to know three things:</p>
<ol type="1">
<li>The <em>projection</em> of your data’s coordinates when you read it in</li>
<li>The <em>projection</em> you want your data to be in when you map it</li>
<li>The <em>projection</em> of other spatial data you may want to combine.</li>
</ol>
<section id="importing-projected-data" class="level4">
<h4 class="anchored" data-anchor-id="importing-projected-data">Importing projected data</h4>
<p>GEOJSON, shapefiles, and KML files usually come with embedded projections stored as <strong>EPSG</strong> numbers like ‘4326’ (incidentally, ‘4326’ is the usual projection for GPS coordinates). Thus, the first one is usually already taken care of. If your data doesnt have a PROJ4 or EPSG number but the coordinates are all between -180 and +180, it’s likely in EPSG=4326. If none of those, then the data creator should have <em>metadata</em> stating the proejction. It might take some googling and some trial and error.</p>
<p>For mapping, you might need to <em>transform</em> your data between projections (or “reproject” it, same thing). We use <code>st_transform</code> for this. We only need to give <code>R</code> the EPSG (Geodetic Parameter Dataset) of the projection you want to end up in. As long as it’s already in a known projection, <code>R</code> can re-project it. The projection is refered to by the Coordinate Reference System (CRS). <code>st_crs</code> will tell us the projection (EPSG number and a lot more) of any spatial object. If they do not match, then <code>R</code> will give an error or, worse, plot them on totally different scales - sometimes you end up with points from the US landing in the middle of the Indian Ocean! In fact, look back at our map of gas plants and the US.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(gasplants)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Coordinate Reference System:
  User input: WGS 84 
  wkt:
GEOGCRS["WGS 84",
    DATUM["World Geodetic System 1984",
        ELLIPSOID["WGS 84",6378137,298.257223563,
            LENGTHUNIT["metre",1]]],
    PRIMEM["Greenwich",0,
        ANGLEUNIT["degree",0.0174532925199433]],
    CS[ellipsoidal,2],
        AXIS["geodetic latitude (Lat)",north,
            ORDER[1],
            ANGLEUNIT["degree",0.0174532925199433]],
        AXIS["geodetic longitude (Lon)",east,
            ORDER[2],
            ANGLEUNIT["degree",0.0174532925199433]],
    ID["EPSG",4326]]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(MI)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Coordinate Reference System:
  User input: NAD83 
  wkt:
GEOGCRS["NAD83",
    DATUM["North American Datum 1983",
        ELLIPSOID["GRS 1980",6378137,298.257222101,
            LENGTHUNIT["metre",1]]],
    PRIMEM["Greenwich",0,
        ANGLEUNIT["degree",0.0174532925199433]],
    CS[ellipsoidal,2],
        AXIS["latitude",north,
            ORDER[1],
            ANGLEUNIT["degree",0.0174532925199433]],
        AXIS["longitude",east,
            ORDER[2],
            ANGLEUNIT["degree",0.0174532925199433]],
    ID["EPSG",4269]]</code></pre>
</div>
</div>
<p><code>gasplants</code> from HIFLD is in EPSG: 4326, the map of MI is in EPSG: 4269. We can use <code>st_transform</code> on the <code>gasplants</code> data, which will reproject the points (and won’t change the data at all). The data won’t be any different, and the points won’t look too much different</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>gasplants <span class="ot">=</span> gasplants <span class="sc">%&gt;%</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="at">crs=</span><span class="dv">4269</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(gasplants) <span class="sc">+</span> <span class="fu">geom_sf</span>() <span class="sc">+</span> <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15a_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>But in a bit, when we spatially join, we’ll avoid an error.</p>
</section>
<section id="importing-unprojected-data" class="level4">
<h4 class="anchored" data-anchor-id="importing-unprojected-data">Importing unprojected data</h4>
<p>Sometimes, we have data only in .csv format, but with X and Y coordinates (e.g.&nbsp;Longitude and Latitude). To import this data, we do the following:</p>
<ul>
<li>Read in from .csv, .xls, etc.</li>
<li>Determine the CRS of the data (usually 4326 for gps coordinates)</li>
<li>Set the spatial coordinates and CRS</li>
</ul>
<p>We know how to do the first, and the 2nd and 3rd are done in one step. We’ll make a data.frame of city names and use the <code>tmaptools</code> package’s <code>geocode_OSM</code> to get the latitudes and longitudes of the city centers. This function uses open-source Open Street Maps instead of the google API (which is used by <code>ggmap</code>). This way, we don’t need an API key.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>ourCities <span class="ot">=</span> <span class="fu">geocode_OSM</span>(<span class="fu">c</span>(<span class="st">'Detroit'</span>,<span class="st">'Lansing'</span>,<span class="st">'Grand Rapids'</span>,<span class="st">'Kalamazoo'</span>,<span class="st">'Traverse City'</span>,<span class="st">'Marquette'</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">City =</span> query, <span class="at">lat =</span> lat, <span class="at">lon =</span> lon)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ourCities)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           City      lat       lon
1       Detroit 42.33155 -83.04664
2       Lansing 42.73383 -84.55463
3  Grand Rapids 42.96324 -85.66786
4     Kalamazoo 42.29171 -85.58723
5 Traverse City 44.76065 -85.61660
6     Marquette 46.44815 -87.63059</code></pre>
</div>
</div>
<p>Since these are GPS-type coordinates, we are going to assume the CRS is EPSG=4326. Longitude is the “x” axis, and latitude is the “y” axis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>ourCities.spatial <span class="ot">=</span> <span class="fu">st_as_sf</span>(ourCities, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">'lon'</span>,<span class="st">'lat'</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ourCities.spatial)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 1 field
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -87.63059 ymin: 42.29171 xmax: -83.04664 ymax: 46.44815
Geodetic CRS:  WGS 84
           City                   geometry
1       Detroit POINT (-83.04664 42.33155)
2       Lansing POINT (-84.55463 42.73383)
3  Grand Rapids POINT (-85.66786 42.96324)
4     Kalamazoo POINT (-85.58723 42.29171)
5 Traverse City  POINT (-85.6166 44.76065)
6     Marquette POINT (-87.63059 46.44815)</code></pre>
</div>
</div>
<p>Now we have the point geometries! We can map this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> MI, <span class="at">fill =</span> <span class="st">'gray90'</span>) <span class="sc">+</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> ourCities.spatial, <span class="at">col =</span> <span class="st">'blue'</span>) <span class="sc">+</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15a_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="mis-projected-data" class="level4">
<h4 class="anchored" data-anchor-id="mis-projected-data">Mis-projected data</h4>
<p>Let’s see a <em>bad</em> example that assumes the wrong projection when importing <code>ourCities.spatial</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>ourCities.spatial.bad <span class="ot">=</span> <span class="fu">st_as_sf</span>(ourCities, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">'lon'</span>,<span class="st">'lat'</span>), <span class="at">crs =</span> <span class="dv">4000</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> MI, <span class="at">fill =</span> <span class="st">'gray90'</span>) <span class="sc">+</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> ourCities.spatial.bad, <span class="at">col =</span> <span class="st">'blue'</span>) <span class="sc">+</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15a_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Ope!</strong> That sure doesn’t look right. The wrong projection can derail a project. Luckily, most shapefiles we find in the wild have the projection (CRS) attached. Now you know what a bad one looks like. Back to our correctly-projected data.</p>
</section>
</section>
<section id="spatial-merges" class="level2">
<h2 class="anchored" data-anchor-id="spatial-merges">Spatial merges</h2>
<p>Combining spatial data is the strength of geospatial analysis. We have our map of MI, and we have out points. Let’s “merge” the points to the map, meaning let’s connect the elements in our map (the state of MI) to the elements in our points (gas plants). This is a point-to-polygon merge.</p>
<section id="point-to-polygon-merges" class="level3">
<h3 class="anchored" data-anchor-id="point-to-polygon-merges">Point-to-polygon merges</h3>
<p>We’ll use <code>st_join</code> to produce an inner join, so we keep only those points that are “in” (spatially) the state of Michigan. I’m specifying <code>join = st_intersects</code> though this is the default. Note that all the points that remain in the merged <code>MI.gasplants</code> are in Michigan, and note that all the data columns from <code>MI</code> are now in <code>gasplants</code>. We’ll use a county map of MI here so we will have the <em>county</em> data for each county containing a gas plant.</p>
<div class="cell" data-result="hide">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>MI.counties <span class="ot">=</span> <span class="fu">counties</span>(<span class="at">state =</span> <span class="st">'MI'</span>, <span class="at">cb =</span> <span class="cn">TRUE</span>, <span class="at">progress_bar =</span> <span class="cn">FALSE</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>MI.gasplants <span class="ot">=</span> gasplants <span class="sc">%&gt;%</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="fu">st_crs</span>(MI.counties)) <span class="sc">%&gt;%</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_join</span>(MI.counties, <span class="at">left =</span> <span class="cn">FALSE</span>,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">join =</span> st_intersects)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(MI.gasplants)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 13 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -86.32218 ymin: 43.79656 xmax: -84.01813 ymax: 44.69001
Geodetic CRS:  NAD83
                       name STATEFP COUNTYFP COUNTYNS       AFFGEOID GEOID
20           Aztec Manistee      26      101 01622993 0500000US26101 26101
28             Beaver Creek      26      039 01622962 0500000US26039 26039
148                Fraser 8      26      017 01622951 0500000US26017 26017
162    Goose Lake Gas Plant      26      133 01623009 0500000US26133 26133
212 Kalkaska Gas Processing      26      079 01622982 0500000US26079 26079
268        Marion Gas Plant      26      133 01623009 0500000US26133 26133
        NAME        NAMELSAD STUSPS STATE_NAME LSAD      ALAND     AWATER
20  Manistee Manistee County     MI   Michigan   06 1404616367 1912438858
28  Crawford Crawford County     MI   Michigan   06 1441108421   17887265
148      Bay      Bay County     MI   Michigan   06 1145834939  487713370
162  Osceola  Osceola County     MI   Michigan   06 1466674406   17425113
212 Kalkaska Kalkaska County     MI   Michigan   06 1449729130   28020186
268  Osceola  Osceola County     MI   Michigan   06 1466674406   17425113
                      geometry
20  POINT (-86.32218 44.26337)
28      POINT (-84.818 44.559)
148 POINT (-84.01813 43.79656)
162   POINT (-85.4091 44.1106)
212 POINT (-85.19667 44.69001)
268 POINT (-85.09891 44.08532)</code></pre>
</div>
</div>
<p>Now, we can plot the counties map with the gasplants over it. We can even use <code>aes(...)</code> to <code>fill</code> the counties:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> MI.counties, <span class="fu">aes</span>(<span class="at">fill =</span> NAME), <span class="at">show.legend =</span> F) <span class="sc">+</span>  </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> MI.gasplants) <span class="sc">+</span> </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15a_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Huh. Most gas plants in Michigan are to the north of here. Interesting.</p>
</section>
<section id="mapview" class="level3">
<h3 class="anchored" data-anchor-id="mapview">Mapview</h3>
<p>Sometimes, we want to be able to zoom in and out. <code>ggplot</code> is static, so that won’t work too well. Thanks to the <code>leaflet</code> engine, the <code>mapview</code> packages is stellar for exploration of spatial data. You can specify <code>zcol = Name</code> if you want to color by the <code>Name</code> field. I can’t embed this in the website, but you can run this at home. It will appear in the “Viewer” pane, not in the “Plots” pane. Unlike the static image here, you will be able to zoom and pan.</p>
<pre><code>mapview(MI.gasplants)</code></pre>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="../../images/MIgas.png" class="img-fluid figure-img" width="388"></p>
</figure>
</div>
</div>
</div>
<p>In an actual mapview window (not this static image here), clicking on the points or polygons will bring up a pop-up of the data for that row. Mapview is very useful for <em>exploring</em> your spatial data. It is <strong>not</strong> useful for presenting your data. Please, never use <code>mapview</code> as an output from a markdown code chunk. Use it for exploring, then use <code>geom_sf()</code> to present your analysis.</p>
<p>While Mapview has many features that you will likely find interesting, one of the more useful features is that you can set the display color, which helps for data exploration.</p>
<pre><code>mapview(MI.counties, zcol = 'NAME')</code></pre>
<p>This will set each county in Michigan to a different color (using the <code>viridis</code> colors). Another very useful feature of <code>mapview</code> is that you can layer plots with <code>+</code>. Again, I’m including a static image. Using this command in Rstudio will open an interactive map:</p>
<pre><code>mapview(MI.gasplants) + mapview(MI.counties, zcol = 'NAME')</code></pre>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="../../images/mapview_ex2.png" class="img-fluid figure-img" width="485"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="polygon-to-polygon-merges" class="level3">
<h3 class="anchored" data-anchor-id="polygon-to-polygon-merges">Polygon-to-polygon merges</h3>
<p>The gas plants and state merge, above, was very simple because points are always either within or not within a polygon. Worst that can happen is some of your points are not over any polygon at all (resulting in <code>NA</code> values). But what if you’re merging polygons to polygons?</p>
<p>First, let’s load some (overlapping) polygons. We can load up all of our states again (dropping the territories). We’ll also use a map of watersheds (which cross state boundaries). This is the HUC-4 map of the Rockies from the <a href="https://hub.arcgis.com/datasets/7f8632f3e3114623b4f5c8f97d935dca_1?geometry=-157.095%2C32.305%2C-73.379%2C44.324">US Geological Survey</a>. The HUC-4 is a definition of a watershed where the area of the HUC-4 is the area drained by a major tributary:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>US <span class="ot">=</span> <span class="fu">states</span>(<span class="at">cb=</span><span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>STUSPS <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">'PR'</span>,<span class="st">'GU'</span>,<span class="st">'VI'</span>,<span class="st">'MP'</span>,<span class="st">'AS'</span>,<span class="st">'AK'</span>,<span class="st">'HI'</span>))</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>HUC4 <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">'https://opendata.arcgis.com/datasets/7f8632f3e3114623b4f5c8f97d935dca_1.kml'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="fu">st_crs</span>(US)) <span class="sc">%&gt;%</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">randomData =</span> <span class="fu">rpois</span>(<span class="fu">n</span>(), <span class="dv">20</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `USGS_NHD_Hydrologic_Units__HUCs_' from data source 
  `https://opendata.arcgis.com/datasets/7f8632f3e3114623b4f5c8f97d935dca_1.kml' 
  using driver `KML'
Simple feature collection with 12 features and 2 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -121.5779 ymin: 31.5082 xmax: -109.7625 ymax: 45.25827
Geodetic CRS:  WGS 84</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> US, <span class="at">col =</span> <span class="st">'gray50'</span>) <span class="sc">+</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> HUC4, <span class="fu">aes</span>(<span class="at">fill =</span> Name), <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15a_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>These watersheds clearly overlap state boundaries. So what happens if we merge them? <code>sf</code> will create a new obsveration (row) for every HUC-4 / State combination</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>poly.merge <span class="ot">=</span> HUC4 <span class="sc">%&gt;%</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_join</span>(US, <span class="at">left =</span> <span class="cn">TRUE</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(poly.merge)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 12 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -115.7061 ymin: 31.5082 xmax: -111.5061 ymax: 39.30285
Geodetic CRS:  NAD83
                        Name Description randomData STATEFP  STATENS
1             Lower Colorado                     15      32 01779793
1.1           Lower Colorado                     15      06 01779778
1.2           Lower Colorado                     15      04 01779777
2   Lower Colorado-Lake Mead                     22      49 01455989
2.1 Lower Colorado-Lake Mead                     22      32 01779793
2.2 Lower Colorado-Lake Mead                     22      04 01779777
       AFFGEOID GEOID STUSPS       NAME LSAD        ALAND      AWATER
1   0400000US32    32     NV     Nevada   00 284537290201  1839636284
1.1 0400000US06    06     CA California   00 403671756816 20293573058
1.2 0400000US04    04     AZ    Arizona   00 294363973043   855871553
2   0400000US49    49     UT       Utah   00 213355072799  6529973239
2.1 0400000US32    32     NV     Nevada   00 284537290201  1839636284
2.2 0400000US04    04     AZ    Arizona   00 294363973043   855871553
                          geometry
1   POLYGON ((-114.6233 36.0304...
1.1 POLYGON ((-114.6233 36.0304...
1.2 POLYGON ((-114.6233 36.0304...
2   POLYGON ((-115.0786 39.3005...
2.1 POLYGON ((-115.0786 39.3005...
2.2 POLYGON ((-115.0786 39.3005...</code></pre>
</div>
</div>
<p>Now, every HUC-4 like “Lower Colorado” has multiple observations, one for each STUSPS that it touches. When we plot it, though, each of those observations are still attached to the same HUC-4 polygon. Technically, R is plotting the same HUC multiple times (once for each state) on top of each other, so we don’t see them. This is the equivalent of merging your data in a way that duplicates observations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(poly.merge) <span class="sc">+</span> <span class="fu">geom_sf</span>() <span class="sc">+</span> </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15a_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We have another option in our join - we can ask <code>st_join</code> to keep just the <code>largest</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>poly.merge.largest <span class="ot">=</span> HUC4 <span class="sc">%&gt;%</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_join</span>(US, <span class="at">left =</span> <span class="cn">TRUE</span>, <span class="at">largest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(poly.merge.largest)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 12 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -121.255 ymin: 31.5082 xmax: -111.5061 ymax: 42.3448
Geodetic CRS:  NAD83
                          Name Description randomData STATEFP  STATENS
1               Lower Colorado                     15      04 01779777
2     Lower Colorado-Lake Mead                     22      04 01779777
3    Northern Mojave-Mono Lake                     26      06 01779778
4 Central Nevada Desert Basins                     24      32 01779793
5               North Lahontan                     18      06 01779778
6   Black Rock Desert-Humboldt                     14      32 01779793
     AFFGEOID GEOID STUSPS       NAME LSAD        ALAND      AWATER
1 0400000US04    04     AZ    Arizona   00 294363973043   855871553
2 0400000US04    04     AZ    Arizona   00 294363973043   855871553
3 0400000US06    06     CA California   00 403671756816 20293573058
4 0400000US32    32     NV     Nevada   00 284537290201  1839636284
5 0400000US06    06     CA California   00 403671756816 20293573058
6 0400000US32    32     NV     Nevada   00 284537290201  1839636284
                        geometry
1 POLYGON ((-114.6233 36.0304...
2 POLYGON ((-115.0786 39.3005...
3 POLYGON ((-118.7594 38.3208...
4 POLYGON ((-114.7211 41.2410...
5 POLYGON ((-120.1835 41.9743...
6 POLYGON ((-117.9693 42.3430...</code></pre>
</div>
</div>
<p>Now, there is only <em>one</em> observation per HUC-4, and it corresponds to the state that has the most overlap area-wise. For Lower Colorado, Arizona has the most overlap. There are lots of things besides <code>st_intersect</code> we can use to call two things “joined”. <code>?st_join</code> tells you about them. For instance, we can use <code>join = st_covers</code> and we will only get a merge when HUC-4 completely covers the state.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>HUC4 <span class="sc">%&gt;%</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_join</span>(US, <span class="at">left =</span> <span class="cn">TRUE</span>, <span class="at">join =</span> st_covers) <span class="sc">%&gt;%</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 12 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -121.255 ymin: 31.5082 xmax: -111.5061 ymax: 42.3448
Geodetic CRS:  NAD83
                          Name Description randomData STATEFP STATENS AFFGEOID
1               Lower Colorado                     15    &lt;NA&gt;    &lt;NA&gt;     &lt;NA&gt;
2     Lower Colorado-Lake Mead                     22    &lt;NA&gt;    &lt;NA&gt;     &lt;NA&gt;
3    Northern Mojave-Mono Lake                     26    &lt;NA&gt;    &lt;NA&gt;     &lt;NA&gt;
4 Central Nevada Desert Basins                     24    &lt;NA&gt;    &lt;NA&gt;     &lt;NA&gt;
5               North Lahontan                     18    &lt;NA&gt;    &lt;NA&gt;     &lt;NA&gt;
6   Black Rock Desert-Humboldt                     14    &lt;NA&gt;    &lt;NA&gt;     &lt;NA&gt;
  GEOID STUSPS NAME LSAD ALAND AWATER                       geometry
1  &lt;NA&gt;   &lt;NA&gt; &lt;NA&gt; &lt;NA&gt;    NA     NA POLYGON ((-114.6233 36.0304...
2  &lt;NA&gt;   &lt;NA&gt; &lt;NA&gt; &lt;NA&gt;    NA     NA POLYGON ((-115.0786 39.3005...
3  &lt;NA&gt;   &lt;NA&gt; &lt;NA&gt; &lt;NA&gt;    NA     NA POLYGON ((-118.7594 38.3208...
4  &lt;NA&gt;   &lt;NA&gt; &lt;NA&gt; &lt;NA&gt;    NA     NA POLYGON ((-114.7211 41.2410...
5  &lt;NA&gt;   &lt;NA&gt; &lt;NA&gt; &lt;NA&gt;    NA     NA POLYGON ((-120.1835 41.9743...
6  &lt;NA&gt;   &lt;NA&gt; &lt;NA&gt; &lt;NA&gt;    NA     NA POLYGON ((-117.9693 42.3430...</code></pre>
</div>
</div>
<p>None of the HUC-4’s completely cover a state, so we get <code>NA</code> for all the state data.</p>
<p>The other thing we can do is ask <code>R</code> to create separate polygons - one for every HUC-4 / state combination. That isn’t a merge, but it plays a similar role. Note this uses <code>st_intersection</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>poly.int <span class="ot">=</span> HUC4 <span class="sc">%&gt;%</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_intersection</span>(US) <span class="sc">%&gt;%</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Name)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(poly.int)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 12 fields
Geometry type: GEOMETRY
Dimension:     XY
Bounding box:  xmin: -120.4649 ymin: 35.40541 xmax: -114.1471 ymax: 42.3448
Geodetic CRS:  NAD83
                            Name Description randomData STATEFP  STATENS
6     Black Rock Desert-Humboldt                     14      32 01779793
6.1   Black Rock Desert-Humboldt                     14      06 01779778
6.2   Black Rock Desert-Humboldt                     14      41 01155107
7               Central Lahontan                     16      32 01779793
7.1             Central Lahontan                     16      06 01779778
4   Central Nevada Desert Basins                     24      32 01779793
       AFFGEOID GEOID STUSPS       NAME LSAD        ALAND      AWATER
6   0400000US32    32     NV     Nevada   00 284537290201  1839636284
6.1 0400000US06    06     CA California   00 403671756816 20293573058
6.2 0400000US41    41     OR     Oregon   00 248628414476  6170965739
7   0400000US32    32     NV     Nevada   00 284537290201  1839636284
7.1 0400000US06    06     CA California   00 403671756816 20293573058
4   0400000US32    32     NV     Nevada   00 284537290201  1839636284
                          geometry
6   MULTIPOLYGON (((-119.9997 4...
6.1 MULTIPOLYGON (((-119.9997 4...
6.2 MULTIPOLYGON (((-118.7203 4...
7   POLYGON ((-120.0065 39.2721...
7.1 POLYGON ((-120.0016 39.5794...
4   POLYGON ((-115.1379 35.4054...</code></pre>
</div>
</div>
<p>Now, we have a unique polygon for every combination of HUC-4 and State (with the US):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> US, <span class="at">fill =</span> <span class="st">'gray50'</span>) <span class="sc">+</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> poly.int, <span class="fu">aes</span>(<span class="at">fill =</span> STUSPS), <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15a_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Here, I’ve set the fill to the state, but you can see that the HUC-4’s have boundaries at the state line.</p>
</section>
<section id="summarizing" class="level3">
<h3 class="anchored" data-anchor-id="summarizing">Summarizing</h3>
<p>Our <code>summarize</code> function let us collapse by groups and calculate interseting things like average (over a group or region). The neat part is that <em>it works on spatial data as well</em>. Let’s look at the data again:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(poly.int <span class="sc">%&gt;%</span> </span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>       dplyr<span class="sc">::</span><span class="fu">select</span>(Name, randomData, STUSPS) <span class="sc">%&gt;%</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>       <span class="fu">arrange</span>(STUSPS))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 3 fields
Geometry type: GEOMETRY
Dimension:     XY
Bounding box:  xmin: -120.4649 ymin: 32.2603 xmax: -111.5061 ymax: 41.10578
Geodetic CRS:  NAD83
                            Name randomData STUSPS
1.2               Lower Colorado         15     AZ
2.2     Lower Colorado-Lake Mead         22     AZ
6.1   Black Rock Desert-Humboldt         14     CA
7.1             Central Lahontan         16     CA
4.1 Central Nevada Desert Basins         24     CA
1.1               Lower Colorado         15     CA
                          geometry
1.2 POLYGON ((-114.8165 32.5069...
2.2 POLYGON ((-114.7368 36.0159...
6.1 MULTIPOLYGON (((-119.9997 4...
7.1 POLYGON ((-120.0016 39.5794...
4.1 MULTIPOLYGON (((-118.7021 3...
1.1 POLYGON ((-115.1379 35.4054...</code></pre>
</div>
</div>
<p>So AZ has two HUC-4’s in it - Lower Colorado and Lower Coloardo - Lake Mead (you can see them above). Summarize on geospatial data works just like regular data - we can <code>group_by(STUSPS)</code>, and we can <code>summarize()</code> any of the data. I threw some random data into <code>HUC-4</code> so we can summarize that.</p>
<p>But how do we combine data specific to each HUC-4 in AZ? We could:</p>
<ul>
<li><p>Just take the average of all of the <code>randomData</code> values within the state.</p></li>
<li><p>Take a weighted average of <code>randomData</code> where the <em>area</em> is the weight</p></li>
<li><p>Take some other function (min, max, etc.) of <code>randomData</code>.</p></li>
</ul>
<p>We can implement any of these using <code>sf</code>. Let’s do the second since it nests the first. First, we’ll add the area of the State x HUC-4 using <code>st_area</code>, which gives a <code>units</code> object. We can turn that into a numeric:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>poly.int.summary <span class="ot">=</span> poly.int <span class="sc">%&gt;%</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">State.HUC.area =</span> <span class="fu">as.numeric</span>(<span class="fu">st_area</span>(.))) <span class="sc">%&gt;%</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(STUSPS) <span class="sc">%&gt;%</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">mean.randomData =</span> <span class="fu">weighted.mean</span>(randomData, <span class="at">w =</span> State.HUC.area))</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(poly.int.summary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 2 fields
Geometry type: GEOMETRY
Dimension:     XY
Bounding box:  xmin: -121.5779 ymin: 32.2603 xmax: -111.0436 ymax: 45.25827
Geodetic CRS:  NAD83
# A tibble: 6 × 3
  STUSPS mean.randomData                                                geometry
  &lt;chr&gt;            &lt;dbl&gt;                                          &lt;GEOMETRY [°]&gt;
1 AZ                18.9 POLYGON ((-114.7368 36.01591, -114.737 36.01577, -114.…
2 CA                23.3 POLYGON ((-118.9235 38.25064, -118.9497 38.26894, -118…
3 ID                17.2 POLYGON ((-117.243 44.39097, -117.2351 44.37385, -117.…
4 MT                18   MULTIPOLYGON (((-111.3842 44.75446, -111.3846 44.75484…
5 NV                19.8 POLYGON ((-118.7021 38.09324, -118.6216 38.03439, -118…
6 OR                20.7 POLYGON ((-116.7012 45.24284, -116.7016 45.24301, -116…</code></pre>
</div>
</div>
<p><code>sf</code> with the <code>tidyverse</code> makes it really easy to apply spatial versions of <code>summarize</code> and <code>mutate</code>. Very useful.</p>
<p>If we had wanted to just take the average (ignoring area), we’d just leave out the <code>w = State.HUC.area</code> or just used <code>mean</code>. If we had wanted to take, say, the minimum, we would use <code>min(randomData)</code> instead of <code>weighted.mean</code>. We can use whatever function we want in <code>summarize</code>, just as we did with non-spatial data.</p>
</section>
</section>
<section id="cropping-vs.-merging" class="level2">
<h2 class="anchored" data-anchor-id="cropping-vs.-merging">Cropping vs.&nbsp;merging</h2>
<p>Sometimes, we wish to only crop to a region rather than merging. <code>sf</code> has the <code>st_crop</code> function to do this. Let’s crop our <code>HUC-4</code> data to just the <strong>bounding box</strong> of the state of Nevada</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>HUC4.nv <span class="ot">=</span> HUC4 <span class="sc">%&gt;%</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_crop</span>(US <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(STUSPS<span class="sc">==</span><span class="st">'NV'</span>))</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(HUC4.nv) <span class="sc">+</span> <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> Name), <span class="at">show.legend =</span> F) <span class="sc">+</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> US <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(STUSPS<span class="sc">==</span><span class="st">'NV'</span>),  <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">col =</span> <span class="st">'gray20'</span>, <span class="at">lwd =</span> <span class="dv">3</span> ) <span class="sc">+</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15a_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>If we wanted to actually crop to the state of Nevada (<code>st_crop</code> only uses the bounding box of Nevada), we’d use <code>st_intersection</code> but do the intersection with just the state of Nevada:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>HUC4.nv <span class="ot">=</span> HUC4 <span class="sc">%&gt;%</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_intersection</span>(US <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(STUSPS<span class="sc">==</span><span class="st">'NV'</span>))</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(HUC4.nv) <span class="sc">+</span> <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> Name), <span class="at">show.legend =</span> F) <span class="sc">+</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> US <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(STUSPS<span class="sc">==</span><span class="st">'NV'</span>),  <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">col =</span> <span class="st">'gray20'</span>, <span class="at">lwd =</span> <span class="dv">3</span> ) <span class="sc">+</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15a_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Note that the data for each HUC-4 remains unchanged. If there were something in that data (like “population” or “area”) that is specific to the entire polygon representing the HUC, then cropping the HUC outside of Nevada may lead to misleading data. The moral of the story is: be careful and thoughtful!</p>
<section id="bounding-boxes" class="level3">
<h3 class="anchored" data-anchor-id="bounding-boxes">Bounding boxes</h3>
<p>This introduces a useful concept: the <em>bounding box</em>. The bounding box is defined by the closest 4 points that form a box that perfectly encloses the object (even when the object is not a rectangle). The extent of the above plot is the bounding box for Nevada.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>Nevada.bbox <span class="ot">=</span> <span class="fu">st_bbox</span>(US <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(STUSPS<span class="sc">==</span><span class="st">'NV'</span>))</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>Nevada.bbox</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      xmin       ymin       xmax       ymax 
-120.00646   35.00186 -114.03965   42.00221 </code></pre>
</div>
</div>
<p>The bounding box can be used to frame a “window” in a <code>ggplot</code> using <code>geom_sf()</code>. That is, sometimes, we want to <em>plot</em> just a subsection of a map, but we still want the data to be the whole map. Here’s an example using the HOLC Redlining Maps, which were created in the 1930’s and were used to segregate US housing up until the 1970’s. They are available at the <a href="https://dsl.richmond.edu/panorama/redlining">University of Richmond’s <em>Mapping Inequality</em> site</a>. We can load Lansing and Detroit using the code below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>lansing <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">'https://dsl.richmond.edu/panorama/redlining/static/citiesData/MILansing19XX/geojson.json'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `geojson' from data source 
  `https://dsl.richmond.edu/panorama/redlining/static/citiesData/MILansing19XX/geojson.json' 
  using driver `GeoJSON'
Simple feature collection with 5 features and 14 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -84.60737 ymin: 42.67877 xmax: -84.45292 ymax: 42.77022
Geodetic CRS:  WGS 84</code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>detroit <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">'https://dsl.richmond.edu/panorama/redlining/static/citiesData/MIDetroit1939/geojson.json'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `geojson' from data source 
  `https://dsl.richmond.edu/panorama/redlining/static/citiesData/MIDetroit1939/geojson.json' 
  using driver `GeoJSON'
Simple feature collection with 239 features and 14 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -83.40036 ymin: 42.13495 xmax: -82.87287 ymax: 42.56012
Geodetic CRS:  WGS 84</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>mi.redlining <span class="ot">=</span> <span class="fu">bind_rows</span>(lansing, detroit) <span class="sc">%&gt;%</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="fu">st_crs</span>(MI))</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mi.redlining) <span class="sc">+</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> grade, <span class="at">col =</span> grade)) <span class="sc">+</span> </span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> MI, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">col =</span> <span class="st">'gray50'</span>) <span class="sc">+</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">'A'</span> <span class="ot">=</span> <span class="st">'darkgreen'</span>, <span class="st">'B'</span> <span class="ot">=</span> <span class="st">'blue'</span>, <span class="st">'C'</span> <span class="ot">=</span> <span class="st">'yellow'</span>, <span class="st">'D'</span> <span class="ot">=</span> <span class="st">'red'</span>),</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>                    <span class="at">aesthetics =</span> <span class="fu">c</span>(<span class="st">'color'</span>,<span class="st">'fill'</span>)) <span class="sc">+</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15a_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can tell that our polygons have plotted, but since we have the whole state of Michigan, they’re almost unreadable. We need to set our window over the lower part of the lower peninsula. We’ll use <code>coord_sf</code> to do this, but first we need to define a window. Since windows are almost always rectangular, we can use the <code>st_bbox(mi.redlining)</code>, but we have to pull out the xlim (xmin, xmax) and ylim (ymin, ymax):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mi.redlining) <span class="sc">+</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> grade, <span class="at">col =</span> grade)) <span class="sc">+</span> </span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> MI, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">col =</span> <span class="st">'gray50'</span>) <span class="sc">+</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">'A'</span> <span class="ot">=</span> <span class="st">'green'</span>, <span class="st">'B'</span> <span class="ot">=</span> <span class="st">'blue'</span>, <span class="st">'C'</span> <span class="ot">=</span> <span class="st">'yellow'</span>, <span class="st">'D'</span> <span class="ot">=</span> <span class="st">'red'</span>),</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">aesthetics =</span> <span class="fu">c</span>(<span class="st">'color'</span>,<span class="st">'fill'</span>)) <span class="sc">+</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">st_bbox</span>(mi.redlining)[<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>)],</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">ylim =</span> <span class="fu">st_bbox</span>(mi.redlining)[<span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15a_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="distance-matrices" class="level2">
<h2 class="anchored" data-anchor-id="distance-matrices">Distance matrices</h2>
<p>One of the most common spatial statistics we’d use in data analytics is the <em>distance</em> matrix. If we have a set of points and we think that we can explain some data about those points (unemployment, ag production, murders per capita) based on the distance to some explanatory source (gas plants, superfund site, etc.), then we might want to include <em>distance to gas plants</em> in our model as a predictor. Frequently, we’ll use inverse distance, <span class="math inline">\(\frac{1}{d}\)</span>, so that closer things can have more of an impact. To do this, we need a distance matrix.</p>
<p>Let’s combine our <code>gasplants</code> and our <code>ourCities</code> to get the distance from each of our cities to the nearest gas plant. Maybe we have city-level data on student achievements and we want to see if gas plants lower student achievement. While we would need a lot more information to make this model, we can look at what we have for now.</p>
<p>We will use <code>st_distance</code>, which will generate a special type of object that contains the distance information. <code>MI.gasplants</code> has 9 observations, and ourCities has 6, so for each row in <code>ourCities</code> we will get 9 distances, one to each gasplant. This forms a <em>distance matrix</em> where each row is an object in <code>ourCities</code> and each column is an object in <code>MI.gasplants</code>. We are going to take only a few <code>MI.gasplants</code> so we can easily view the results:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>ourCities.spatial <span class="ot">=</span> ourCities.spatial <span class="sc">%&gt;%</span> </span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="fu">st_crs</span>(MI.gasplants))</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>MI.gasplants.small <span class="ot">=</span> MI.gasplants[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,]</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>ourDistance <span class="ot">=</span> <span class="fu">st_distance</span>(<span class="at">x =</span> ourCities.spatial, <span class="at">y =</span> MI.gasplants.small)</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>ourDistance</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Units: [m]
          [,1]      [,2]     [,3]      [,4]
[1,] 341143.11 285982.39 181009.4 275255.21
[2,] 221918.02 204053.49 125901.8 167922.72
[3,] 153864.33 190110.91 162360.3 129274.21
[4,] 227166.32 259648.90 210370.0 202766.55
[5,]  78661.48  67024.32 166385.3  74135.81
[6,] 263562.31 303561.81 408893.5 312655.34</code></pre>
</div>
</div>
<p>We get a <code>units</code> matrix, which has extra properties that allow us to convert the units. The units will be in whatever the CRS of the objects is in - <code>st_crs(ourCities.spatial)</code> tells us the units are meters.</p>
<p>What if we wanted to find the closest gas plant to each city? That is akin to looking at each row, and finding the column that is the smallest, right? We will use <code>apply</code>, and we will note that the order of the columns is the same as the order in <code>MI.gasplants.small</code>, so we can use <code>MI.gasplants.small$name</code> to tell us the name of the closest gas plant. We will <code>apply</code> over each row (<code>MAR=1</code>) and use the <code>which.min</code> function, which returns the <em>index</em> number of the maximum column.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>max.index <span class="ot">=</span> <span class="fu">apply</span>(ourDistance, <span class="at">MAR =</span> <span class="dv">1</span>, which.min)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can combine this index with the <code>MI.gasplants.small</code> object to get the names of the closest gas plant for each of the cities. We’ll make a nice, neat tibble with the city name (in the order from ourCities.spatial), the closest gas plant name, and the distance to that plant:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">City =</span> ourCities.spatial<span class="sc">$</span>City,</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>       <span class="at">Closest.gasplant =</span> MI.gasplants.small<span class="sc">$</span>name[max.index],</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">Distance.to.closest =</span> ourDistance[<span class="fu">cbind</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(max.index), max.index)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  City          Closest.gasplant     Distance.to.closest
  &lt;chr&gt;         &lt;chr&gt;                                [m]
1 Detroit       Fraser 8                         181009.
2 Lansing       Fraser 8                         125902.
3 Grand Rapids  Goose Lake Gas Plant             129274.
4 Kalamazoo     Goose Lake Gas Plant             202767.
5 Traverse City Beaver Creek                      67024.
6 Marquette     Aztec Manistee                   263562.</code></pre>
</div>
</div>
<p>But wait, what is going on in the last line of code there? Well, recall our distance matrix and <code>max.index</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>ourDistance</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Units: [m]
          [,1]      [,2]     [,3]      [,4]
[1,] 341143.11 285982.39 181009.4 275255.21
[2,] 221918.02 204053.49 125901.8 167922.72
[3,] 153864.33 190110.91 162360.3 129274.21
[4,] 227166.32 259648.90 210370.0 202766.55
[5,]  78661.48  67024.32 166385.3  74135.81
[6,] 263562.31 303561.81 408893.5 312655.34</code></pre>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>max.index</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3 3 4 4 2 1</code></pre>
</div>
</div>
<p>we want to select from our distance matrix the 1st row, 3rd column; the 2nd row, 3rd column; 3rd row, 1st column; 4th row, 3rd column; 5th row, 4th column; and 6th row, 4th column. This means the row index and column index are not ranges, but are paired. Using <code>cbind(1:6, max.index)</code> makes them paired entries, and we can select specific row x column combinations that way.</p>
<section id="st_nearest_feature" class="level3">
<h3 class="anchored" data-anchor-id="st_nearest_feature">st_nearest_feature</h3>
<p>As is common in R, there is a function that will get the closest points between to spatial objects. <code>st_nearest_points</code> takes two geometries, and returns the neaarest point in <code>y</code> for every point in <code>x</code>, which is what we did with the MI gas plants.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_nearest_feature</span>(<span class="at">x =</span> ourCities.spatial, <span class="at">y =</span> MI.gasplants.small)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3 3 4 4 2 1</code></pre>
</div>
</div>
<p>This is exactly our <code>max.index</code> and can be used on the <code>y</code> object, <code>MI.gasplants.small</code>, to pull the names, subset, get distances etc.</p>
<p><code>st_nearest_feature</code> also works for points and polygons, or polygons and polygons, where it returns the index of the polygon that contains the nearest point to the features in <code>x</code>. Let’s find the nearest Great Lake for each of our cities using a <a href="https://hub.arcgis.com/datasets/wi-dnr::great-lakes?geometry=-127.301%2C37.038%2C-43.585%2C48.298">KML shapefile of the Great Lakes from WI DNR</a> Note that the GeoJSON link is under “API” on this site. We run into a complex geometry problem, and add <code>st_make_valid()</code> to fix it:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>GL <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">'https://opendata.arcgis.com/datasets/a8bb79fc10e64eee8c3a9db97cc5dc80_4.geojson'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="fu">st_crs</span>(ourCities.spatial)) <span class="sc">%&gt;%</span> <span class="fu">st_make_valid</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `Great_Lakes' from data source 
  `https://opendata.arcgis.com/datasets/a8bb79fc10e64eee8c3a9db97cc5dc80_4.geojson' 
  using driver `GeoJSON'
Simple feature collection with 15 features and 3 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -92.10222 ymin: 41.38576 xmax: -75.95819 ymax: 49.00535
Geodetic CRS:  WGS 84</code></pre>
</div>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>closest.GL.index <span class="ot">=</span> <span class="fu">st_nearest_feature</span>(<span class="at">x =</span> ourCities.spatial, <span class="at">y =</span> GL)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>ourCities <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">Closest.GreatLake =</span> GL<span class="sc">$</span>FEAT_NAME[closest.GL.index])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           City      lat       lon Closest.GreatLake
1       Detroit 42.33155 -83.04664         Lake Erie
2       Lansing 42.73383 -84.55463        Lake Huron
3  Grand Rapids 42.96324 -85.66786     Lake Michigan
4     Kalamazoo 42.29171 -85.58723     Lake Michigan
5 Traverse City 44.76065 -85.61660     Lake Michigan
6     Marquette 46.44815 -87.63059     Lake Superior</code></pre>
</div>
</div>
</section>
</section>
<section id="other-resources" class="level2">
<h2 class="anchored" data-anchor-id="other-resources">Other resources</h2>
<ul>
<li><p>Claudia Engel’s “<a href="https://cengel.github.io/R-spatial/">Using Spatial Data with R</a>” is a very useful resource. It covers <code>sf</code> and an older geospatial library called <code>sp</code> that has similar functionality but was not tidyverse-friendly.</p></li>
<li><p>The <a href="https://github.com/rstudio/cheatsheets/raw/master/sf.pdf">Rstudio Spatial Cheat Sheet</a>.</p>
<ul>
<li>There are <a href="https://www.rstudio.com/resources/cheatsheets/">lots of useful RStudio cheat sheets, actually.</a></li>
</ul></li>
<li><p>If you want to remove the Great Lakes from your map, here’s how you do it</p>
<ul>
<li><p>First, retrieve the geojson file of the great lakes. Only WI DNR seems to have a public shapefile of the Great Lakes (an informal complaint has been registered with MI-EGLE, grrrr) which you can download as a <a href="https://data-wi-dnr.opendata.arcgis.com/datasets/great-lakes/explore">geojson from here</a> – see the little cloud download button, and select geojson. This one doesn’t have a link to take it directly, so download the file to your local drive, keep it with your .RMD file, and load it direction from your local path.</p></li>
<li><p>Second, use the code below as an example. You may have a different shapefile you want to clip to the Great Lakes – put it in place of <code>MI</code> below. Note that we use a spatial version of the <code>difference</code> function, which gives us “everything in the first that isn’t in the second”.</p></li>
</ul></li>
</ul>
<pre><code>library(sf)
library(tidyverse)
library(tigris)


MI = counties(state = 'MI', year = 2019) # your map here
GreatLakes = st_read('/PUT YOUR LOCAL FILEPATH TO THE GEOJSON HERE.geojson') %&gt;%  # put your local filepath in here
  st_transform(st_crs(MI)) %&gt;%  # need them to be in the same projection
  st_make_valid() %&gt;%  # this fixes an issue with the shapefile after projection
  st_union()  # we will put all the lakes together as we don't care which lake is being used to erase county/district boundaries


MIx = st_difference(MI, GreatLakes)  # spatial version of the difference function</code></pre>
<p>or, try the <code>erase_water()</code> function from <code>tigris</code>. This erases any body of water, no matter how small, so on a whole state, it can take a <strong>long</strong> time. The <code>area_threshold</code> argument (0 to 1) tells R how detailed you want the erasure to be. A threshold of .999 will remove Great Lakes and big lakes, but leave most inland lakes and won’t take as long.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>MI <span class="ot">=</span> <span class="fu">counties</span>(<span class="at">state =</span> <span class="st">'MI'</span>, <span class="at">progress_bar =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="fu">erase_water</span>(<span class="at">area_threshold =</span> .<span class="dv">999</span>)</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(MI) <span class="sc">+</span> <span class="fu">geom_sf</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15a_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>